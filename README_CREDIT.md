README_CREDIT.md

# クレジット課金ルール
本リポジトリでは、**AIあべむつき動画生成システム**のクレジット課金ルールを定義します。  
このファイルは GitHub Copilot が実装時に参照するための仕様書です。  

独自決済システムがあるので、クレジットを直接購入する場合は
クレジット単体購入のルールに従ってポイントを付与します。
例えば1万円の課金で50クレジットを目安にしています。

また、本システムではオンラインあべラボの決済と連動してクレジットが付与される仕組みがあります。
あべラボの決済方法はいくつかあるので、複数の実装が必要です。



---

## 基本ルール
- **1クレジット = 30秒動画生成**  
- Heygenの課金仕様（30秒単位で課金）に対応しています。
- 切り上げでクレジットは消費されます。
例：28秒で1クレジット、50秒で2クレジット、61秒で3クレジットになります。
60.1秒でも3クレジットです。


---

## クレジット単体購入
- **10,000円 = 50クレジット**  
  - 実質：25分分の動画生成が可能  
  - 原価：約7,425円（採算確保のため、ユーザー付与は50クレジットに固定）

---

## サロン「あべラボ」会員特典
サロン月額：**10,000円**

- **入会時特典：20クレジット付与**  
  - 10分分の動画相当  
  - 初回加入のインパクトを強調  

- **継続特典：毎月10クレジット付与**  
  - 5分分の動画相当  
  - サロン継続で「毎月のお小遣い」感覚  

---

## 計算例
- 単体課金：1万円支払い → 50クレジット付与  
- サロン入会初月：1万円支払い → 50クレジット（購入分）＋20クレジット（初回ボーナス）  
- サロン2ヶ月目以降：毎月1万円支払い → 50クレジット（購入分）＋10クレジット（継続ボーナス）

---

## 実装における留意点
1. クレジット残高はユーザーごとに管理すること。  
2. ボーナスクレジットは**サロン課金処理と同時に自動付与**すること。  
3. 将来的に「キャンペーンで追加クレジット付与」できるように、付与数は設定値から読み込めるようにすること。  
4. 返金や解約の場合、付与済みクレジットの取り扱いは別途ルールを定めること。  

---

## 補足
- クレジットの有効期限は現状**無期限**（将来的に設定可能性あり）  
- 表示は「残りクレジット数」と「換算可能動画時間」を併記するとユーザーに分かりやすい  




## あべラボ課金、インフォトップ決済の場合
インフォトップ決済の場合は、スプレッドシートで管理されているデータを定期的に読み取って
新規データがあれば、決済金額に従ってクレジットを付与します。

重複して付与しないように、クレジットを追加するときは注文IDをレコードに保存しておいて、
重複する注文IDが存在しない場合のみクレジットを付与します。

スプレッドシートのURLは以下
https://docs.google.com/spreadsheets/d/18pHbkmTbF7SPK6CYwqV2eXM2gCxQUNy_MXqbJT4myJM/edit?usp=sharing

参考データとして_docs以下にinfotop_sales.tsvのファイルを置いています。

## あべラボ課金、独自決済の場合
独自決済システムでもあべラボは入会を受け付けています。
payzというシステムを使っています。
こっちはwebhookが使えるので、それでポイント付与を実装します。


# クレジットの付与時のアカウントチェックについて
決済データとアカウント情報を紐づけるために、
データベース上で、あべラボアカウント情報としてあべラボ決済時のメールアドレスと名前、電話番号を入力してもらうことにします。

## インフォトップ決済の場合
スプレッドシートと照らし合わせてメールアドレス、名前、電話番号が一致しているアカウントにクレジットを付与します。
クレジット付与履歴のテーブルに注文IDを保存して、重複を避けてください。

## 独自課金（payz）の場合
前述の通りwebhookが使えます。
リクエストフォーマットは以下の通り

Content-Type: application/json
{
  "subscription_uid": <string>, //定期購読ごとに一意なID
  "membership_uid": <string>, //定期購読商品ごとに一意なID
  "user_uid": <string|null>, //ユーザごとに一意なID
  "email": <string>, //メールアドレス
  "status": <string>, //ステータス（"subscribing", "void"）

  "name_last": <string|null>, //名前（姓）
  "name_first": <string|null>, //名前（名）
  "kana_last": <string|null>, //かな（せい）
  "kana_first": <string|null>, //かな（めい）

  "prefecture": <string|null>, //都道府県
  "city": <string|null>, //市区町村
  "address1": <string|null>, //住所
  "address2": <string|null>, //建物名、部屋番号
  "zip": <string|null>, //郵便番号

  "tel": <string>, //TEL
  "fax": <string|null>, //FAX
  "dob": <string|null>, //生年月日

  "client_ip": <string|null>, //購入時に使用されたIP
  "client_ua": <string|null>, //購入時に使用されたUserAgent
}
payz決済の場合はsubscription_uidを注文IDとして使用して重複を避ければOKです。

# 決済履歴テーブルについて
注文ID、金額、付与したポイント、日時、決済システム名（infotop/payz_abelabo/payz_directなど）などのデータを格納します。


infotopはインフォトップ決済のあべラボ課金
payz_abelaboはpayzシステムのあべラボ課金
payz_directは直接クレジットを購入した場合のレコードを想定しています。




# 管理画面からクレジットを追加する場合
クレジット追加ページでは、
クレジット数、金額、備考（note）のみの入力フォームで最低限の項目で追加
systemには自動でadminとする
編集時は全項目が編集できます。

注文IDにはADMIN_XXXXXXXXというランダム文字列を入れてください
ADMIN_が接頭辞でXXXXXXXXの部分はランダム生成文字列です。
ADMIN_＋ランダム8文字（英数字大文字・小文字可）
